@page "/"
@using RoamingRoutes.Shared.Models.Games
@using RoamingRoutes.Client.Services
@using Microsoft.AspNetCore.Components.Web
@inject RoamingRoutes.Client.Services.ILocalGameService LocalGameService
@inject RoamingRoutes.Client.Services.IWordPairClientService WordPairService

@code {
    // Simple local class for game results since GameResultDTO is not in the shared models
    public class GameResultDTO
    {
        public string Winner { get; set; } = "";
        public string Reason { get; set; } = "";
    }
}

<div class="container">
    
    @if (gamePhase == GamePhase.Setup)
    {
        <!-- Game Setup -->
        <div class="card">
            <div class="card-header">
                <h1>üé≠ Undercover</h1>
                <p style="color: var(--text-muted); text-align: center; margin: 0.5rem 0;">A social deduction game where players try to identify the "undercover" agent(s). Perfect for groups of 3-10 people. Test your wit and deduction skills!</p>
                <p style="color: var(--text-muted); text-align: center; margin: 0; font-size: 0.9rem;">Pass the device around to play with friends!</p>
            </div>
            
            <!-- Word Category Selection -->
            <div class="form-group">
                <label class="form-label">Word Category</label>
                @if (wordCategories.Any())
                {
                    <select @bind="selectedCategoryName" class="form-control">
                        @foreach (var category in wordCategories)
                        {
                            <option value="@category.Name">@category.Name</option>
                        }
                    </select>
                    @if (!string.IsNullOrEmpty(selectedCategoryName))
                    {
                        var selectedCategory = wordCategories.FirstOrDefault(c => c.Name == selectedCategoryName);
                        @if (selectedCategory != null)
                        {
                            <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 0.5rem;">@selectedCategory.Description</p>
                            <p style="color: var(--text-muted); font-size: 0.8rem;">@selectedCategory.Pairs.Count word pairs available</p>
                        }
                    }
                }
                else
                {
                    <div style="color: var(--text-muted); font-size: 0.9rem;">Loading word categories...</div>
                }
            </div>
            
            <!-- Player Count -->
            <div class="form-group">
                <label class="form-label">Number of Players: @playerCount</label>
                <input type="range" min="3" max="10" @bind="playerCount" @oninput="OnPlayerCountChanged" class="form-control" style="height: 2rem;" />
                <div style="display: flex; justify-content: space-between; color: var(--text-muted); font-size: 0.8rem; margin-top: 0.5rem;">
                    <span>3</span><span>4</span><span>5</span><span>6</span><span>7</span><span>8</span><span>9</span><span>10</span>
                </div>
            </div>

            <!-- Role Distribution -->
            <div class="phase-indicator">
                <div class="phase-title">Role Distribution</div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1rem;">
                    <div style="text-align: center;">
                        <div style="width: 3rem; height: 3rem; background: var(--accent-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 0.5rem; color: white; font-weight: 700;">@GetCivilianCount()</div>
                        <div style="font-weight: 600; color: var(--text-primary);">Civilians</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Good guys</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="width: 3rem; height: 3rem; background: var(--danger); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 0.5rem; color: white; font-weight: 700;">@GetUndercoverCount()</div>
                        <div style="font-weight: 600; color: var(--text-primary);">Undercover</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Secret agent</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="width: 3rem; height: 3rem; background: var(--text-muted); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 0.5rem; color: white; font-weight: 700;">@GetMisterWhiteCount()</div>
                        <div style="font-weight: 600; color: var(--text-primary);">Mr. White</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Mystery role</div>
                    </div>
                </div>
            </div>

            <!-- Quick Start Players -->
            @if (suggestedNames.Any())
            {
                <div class="form-group">
                    <label class="form-label">Quick Start - Suggested Players</label>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.5rem;">
                        @foreach (var name in suggestedNames.Take(playerCount - players.Count))
                        {
                            <button @onclick="() => AddSuggestedPlayer(name)" class="btn btn-secondary" style="padding: 0.5rem;">
                                + @name
                            </button>
                        }
                    </div>
                    @if (suggestedNames.Count > playerCount - players.Count)
                    {
                        <button @onclick="GenerateSuggestedNames" class="btn btn-secondary" style="margin-top: 0.5rem; font-size: 0.9rem;">
                            üé≤ Generate different names
                        </button>
                    }
                </div>
            }

            <!-- Current Players -->
            @if (players.Any())
            {
                <div class="form-group">
                    <label class="form-label">Players (@players.Count/@playerCount)</label>
                    <div class="player-list">
                        @foreach (var player in players)
                        {
                            <div class="player-chip">
                                <span class="player-name">@player.Name</span>
                                <button @onclick="() => RemovePlayer(player)" class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">Remove</button>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Add Player -->
            <div class="form-group">
                <label class="form-label">Add Player</label>
                <div style="display: flex; gap: 0.5rem;">
                    <input @bind="newPlayerName" @onkeypress="OnPlayerNameKeyPress" placeholder="Enter player name" class="form-control" />
                    <button @onclick="AddPlayer" disabled="@(!CanAddPlayerWithName())" class="btn btn-primary">Add</button>
                </div>
            </div>

            <!-- Start Game -->
            <div style="text-align: center; margin-top: 2rem;">
                <button @onclick="StartGame" disabled="@(!CanStartGame())" class="btn btn-primary" style="font-size: 1.1rem; padding: 1rem 2rem;">
                    @if (gameState?.Status == GameStatus.InProgress)
                    {
                        <span>Starting...</span>
                    }
                    else
                    {
                        <span>Start Undercover Game (@players.Count players)</span>
                    }
                </button>
            </div>
        </div>
    }
    else if (gamePhase == GamePhase.RoleAssignment)
    {
        <!-- Role Assignment Phase -->
        <div class="card">
            <div class="card-header">
                <h1>ÔøΩ @players[currentCardIndex].Name's Turn</h1>
                <p style="color: var(--text-muted); text-align: center; margin: 0;">Pass the device to @players[currentCardIndex].Name to pick their card</p>
            </div>
            
            <!-- Available Cards -->
            <div style="text-align: center; margin-bottom: 2rem;">
                <h3 style="color: var(--text-secondary); margin-bottom: 2rem;">Choose Your Card (@availableCards.Count remaining)</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1.5rem; max-width: 600px; margin: 0 auto;">
                    @for (int i = 0; i < availableCards.Count; i++)
                    {
                        var cardIndex = i;
                        <div @onclick="() => PickCard(cardIndex)" 
                             class="game-card"
                             style="aspect-ratio: 0.7; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius: 16px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; font-size: 3.5rem; box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3); border: 2px solid rgba(255, 255, 255, 0.1);"
                             onmouseover="this.style.transform='scale(1.08) translateY(-8px)'; this.style.boxShadow='0 12px 35px rgba(139, 92, 246, 0.4)';" 
                             onmouseout="this.style.transform='scale(1) translateY(0)'; this.style.boxShadow='0 8px 25px rgba(139, 92, 246, 0.3)';">
                            üÉè
                        </div>
                    }
                </div>
            </div>

            <!-- Instructions -->
            <div style="background: var(--bg-glass); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center;">
                <p style="color: var(--text-muted); margin: 0; font-size: 1.1rem;">Click on any card above to reveal your role and see your secret word</p>
            </div>
        </div>
    }
    else if (gamePhase == GamePhase.RoleRevealed)
    {
        <!-- Role Revealed -->
        <div class="card">
            <div class="card-header">
                <h1>üîç Your Word</h1>
            </div>
            
            <!-- Word Display -->
            <div style="text-align: center; margin-bottom: 3rem;">
                @if (currentPlayerRole != null)
                {
                    @if (currentPlayerRole == GameConstants.PlayerRoles.Civilian)
                    {
                        <div class="word-display">
                            <div class="word-category">Your Word</div>
                            <div class="word-text">@currentGameWordPair?.Civilian</div>
                        </div>
                    }
                    else if (currentPlayerRole == GameConstants.PlayerRoles.Undercover)
                    {
                        <div class="word-display">
                            <div class="word-category">Your Word</div>
                            <div class="word-text">@currentGameWordPair?.Undercover</div>
                        </div>
                    }
                    else if (currentPlayerRole == GameConstants.PlayerRoles.MrWhite)
                    {
                        <div class="word-display">
                            <div class="word-category">You are Mr. White!</div>
                            <div class="word-text">Try to blend in.</div>
                        </div>
                    }
                }
            </div>

            <!-- Continue Button -->
            <div style="text-align: center;">
                <button @onclick="ContinueToNextPlayer" class="btn btn-primary" style="font-size: 1.1rem; padding: 1rem 2rem;">
                    @if (currentCardIndex < players.Count - 1)
                    {
                        <span>Continue to Next Player</span>
                    }
                    else
                    {
                        <span>Start Word Sharing</span>
                    }
                </button>
            </div>
        </div>
    }
    else if (gamePhase == GamePhase.Discussion)
    {
        <!-- Word Sharing Phase -->
        <div class="card">
            <div class="card-header">
                <h1>ÔøΩ Word Sharing Phase</h1>
                <p style="color: var(--text-muted); text-align: center; margin: 0;">Each player says a word related to their card. Follow the order below!</p>
            </div>
            
            <!-- Speaking Order -->
            <div class="phase-indicator">
                <div class="phase-title">Speaking Order</div>
                <div class="phase-description">Each player says one word related to their card</div>
            </div>

            <!-- Players List in Speaking Order -->
            <div class="form-group">
                <label class="form-label">Speaking Order</label>
                <div class="player-list">
                    @{
                        var speakingOrder = GetSpeakingOrder();
                        for (int i = 0; i < speakingOrder.Count; i++)
                        {
                            var player = speakingOrder[i];
                            <div class="player-chip">
                                <span class="player-name">@((i + 1)). @player.Name</span>
                            </div>
                        }
                    }
                </div>
            </div>

            <!-- Instructions -->
            <div style="background: var(--bg-glass); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                <h4 style="color: var(--accent-primary); margin-bottom: 1rem;">How to Play:</h4>
                <ul style="color: var(--text-muted); margin: 0; padding-left: 1.5rem;">
                    <li>Each player says ONE word related to their card</li>
                    <li>Follow the speaking order shown above</li>
                    <li>Listen carefully to spot who doesn't belong</li>
                    <li>Mr. White needs to blend in without being too obvious</li>
                </ul>
            </div>

            <!-- Manual Progress -->
            <div style="text-align: center;">
                <button @onclick="StartVoting" class="btn btn-primary" style="font-size: 1.1rem; padding: 1rem 2rem;">
                    Start Voting & Discussion
                </button>
            </div>
        </div>
    }
    else if (gamePhase == GamePhase.Voting)
    {
        <!-- Voting & Discussion Phase -->
        <div class="card">
            <div class="card-header">
                <h1>üó≥Ô∏è Voting & Discussion</h1>
                <p style="color: var(--text-muted); text-align: center; margin: 0;">Discuss who you think is the Undercover agent and vote!</p>
            </div>
            
            <!-- Timer -->
            @if (votingTimeRemaining > 0)
            {
                <div class="timer">
                    <div class="timer-value">@FormatTime(votingTimeRemaining)</div>
                    <div class="timer-label">remaining to vote</div>
                </div>
            }
            
            <!-- Vote Cards -->
            <div class="vote-grid">
                @foreach (var player in players)
                {
                    <div class="vote-card @(selectedVoteTarget == player.Id ? "selected" : "")" 
                         @onclick="() => SelectVoteTarget(player.Id)">
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">@player.Name</div>
                        <div style="font-size: 0.9rem; color: var(--text-muted);">Click to vote</div>
                    </div>
                }
            </div>

            <!-- Submit Vote -->
            <div style="text-align: center;">
                <button @onclick="SubmitVote" disabled="@(selectedVoteTarget == null)" class="btn btn-primary" style="font-size: 1.1rem; padding: 1rem 2rem;">
                    Submit Vote
                </button>
            </div>
        </div>
    }
    else if (gamePhase == GamePhase.MrWhiteGuess)
    {
        <!-- Mr. White Guess Phase -->
        <div class="card">
            <div class="card-header">
                <h1>‚ùì Mr. White's Last Chance</h1>
                <p style="color: var(--text-muted); text-align: center; margin: 0;">@votedOutMrWhite?.Name has been voted out! Can you guess the civilian word?</p>
            </div>
            
            <!-- Mr. White Info -->
            <div class="phase-indicator">
                <div class="phase-title">Final Challenge</div>
                <div class="phase-description">If you guess correctly, you win and get 3 points!</div>
            </div>

            <!-- Guess Input -->
            <div class="form-group">
                <label class="form-label">What is the civilian word?</label>
                <div style="display: flex; gap: 0.5rem;">
                    <input @bind="mrWhiteGuess" @onkeypress="OnMrWhiteGuessKeyPress" placeholder="Enter your guess..." class="form-control" style="flex: 1;" />
                    <button @onclick="SubmitMrWhiteGuess" disabled="@string.IsNullOrWhiteSpace(mrWhiteGuess)" class="btn btn-primary">Submit Guess</button>
                </div>
            </div>

            <!-- Instructions -->
            <div style="background: var(--bg-glass); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem;">
                <p style="color: var(--text-muted); margin: 0; text-align: center;">
                    <strong>Pass the device to @votedOutMrWhite?.Name</strong><br />
                    Type the word you think the civilians had. If correct, you win the entire round!
                </p>
            </div>
        </div>
    }
    else if (gamePhase == GamePhase.MrWhiteEliminated)
    {
        <!-- Mr. White Eliminated Phase -->
        <div class="card">
            <div class="card-header">
                <h1>‚ùå Mr. White Eliminated</h1>
                <p style="color: var(--text-muted); text-align: center; margin: 0;">@votedOutMrWhite?.Name guessed incorrectly and has been eliminated!</p>
            </div>
            
            <!-- Elimination Info -->
            <div style="text-align: center; margin-bottom: 2rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üíÄ</div>
                <h2 style="color: var(--danger); margin-bottom: 1rem;">Wrong Guess!</h2>
                <div style="background: var(--bg-glass); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <p style="color: var(--text-muted); margin: 0; font-size: 1.1rem;">
                        <strong>@votedOutMrWhite?.Name</strong> guessed: "<strong>@mrWhiteGuess</strong>"<br />
                    </p>
                </div>
                <p style="color: var(--text-muted);">@votedOutMrWhite?.Name is eliminated from this round.</p>
            </div>

            <!-- Continue Button -->
            <div style="text-align: center;">
                @if (players.Count <= 2)
                {
                    <button @onclick="() => gamePhase = GamePhase.Results" class="btn btn-primary" style="font-size: 1.1rem; padding: 1rem 2rem;">
                        View Final Results
                    </button>
                }
                else
                {
                    <button @onclick="StartNewWordRound" class="btn btn-primary" style="font-size: 1.1rem; padding: 1rem 2rem;">
                        Continue New Word Round
                    </button>
                }
            </div>
        </div>
    }
    else if (gamePhase == GamePhase.Results)
    {
        <!-- Results Phase -->
        <div class="card">
            <div class="card-header">
                <h1>üèÜ Game Results</h1>
            </div>
            
            <!-- Winner Display -->
            @if (gameResult != null)
            {
                <div style="text-align: center; margin-bottom: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">
                        @if (gameResult.Winner == "Civilians")
                        {
                            <span>üïµÔ∏è‚Äç‚ôÇÔ∏è</span>
                        }
                        else if (gameResult.Winner == "Undercover")
                        {
                            <span>üé≠</span>
                        }
                        else
                        {
                            <span>‚ùì</span>
                        }
                    </div>
                    <h2 style="color: var(--accent-primary); margin-bottom: 0.5rem;">@gameResult.Winner Wins!</h2>
                    <p style="color: var(--text-muted);">@gameResult.Reason</p>
                </div>

                <!-- Player Roles Revealed -->
                <div class="form-group">
                    <label class="form-label">Player Roles & Scores</label>
                    <div class="player-list">
                        @foreach (var player in players.OrderByDescending(p => p.Score))
                        {
                            <div class="player-chip">
                                <span class="player-name">@player.Name</span>
                                <span class="role-badge role-@player.Role.ToLower()">
                                    @GetRoleDisplayName(player.Role)
                                </span>
                                <span class="score-badge">@player.Score pts</span>
                            </div>
                        }
                    </div>
                </div>

                <!-- Word Reveal -->
                @if (currentGameWordPair != null)
                {
                    <div class="phase-indicator">
                        <div class="phase-title">The Words Were</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <div style="text-align: center;">
                                <div style="font-weight: 600; color: var(--accent-primary);">Civilian Word</div>
                                <div style="font-size: 1.2rem; color: var(--text-primary);">@currentGameWordPair.Civilian</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-weight: 600; color: var(--danger);">Undercover Word</div>
                                <div style="font-size: 1.2rem; color: var(--text-primary);">@currentGameWordPair.Undercover</div>
                            </div>
                        </div>
                    </div>
                }
            }

            <!-- Game Actions -->
            <div style="text-align: center; margin-top: 2rem;">
                <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                    <button @onclick="NextRound" class="btn btn-primary" style="font-size: 1.1rem; padding: 1rem 2rem;">
                        üé≤ Next Round
                    </button>
                    <button @onclick="ResetGame" class="btn btn-secondary" style="font-size: 1.1rem; padding: 1rem 2rem;">
                        üîÑ New Game
                    </button>
                </div>
                <p style="margin-top: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">
                    Next Round keeps the same players ‚Ä¢ New Game starts fresh
                </p>
            </div>
        </div>
    }
</div>

@code {
    // Game state
    private GamePhase gamePhase = GamePhase.Setup;
    private GameStateDTO? gameState;
    private GameResultDTO? gameResult;
    private List<GamePlayer> players = new();
    private string newPlayerName = "";
    private int playerCount = 5;
    
    // Word categories
    private List<WordPairCategory> wordCategories = new();
    private string selectedCategoryName = "";
    
    // Role assignment
    private List<(string Role, WordPair? WordPair)> availableCards = new();
    private int currentCardIndex = 0;
    private string? currentPlayerRole;
    private WordPair? currentGameWordPair;
    
    // Discussion & Voting
    private int discussionTimeRemaining = 0;
    private Timer? discussionTimer;
    private int votingTimeRemaining = 0;
    private Timer? votingTimer;
    private string? selectedVoteTarget;
    
    // Mr. White guess
    private GamePlayer? votedOutMrWhite;
    private string mrWhiteGuess = "";
    
    // Suggested players
    private List<string> suggestedNames = new();
    
    // Local player class with role
    public class GamePlayer
    {
        public string Id { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public string Role { get; set; } = string.Empty;
        public int Score { get; set; } = 0;
    }
    
    private enum GamePhase
    {
        Setup,
        RoleAssignment,
        RoleRevealed,
        Discussion,
        Voting,
        MrWhiteGuess,
        MrWhiteEliminated,
        Results
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadWordCategories();
        GenerateSuggestedNames();
    }

    private async Task LoadWordCategories()
    {
        try
        {
            wordCategories = await WordPairService.GetCategoriesAsync();
            if (wordCategories.Any())
            {
                selectedCategoryName = wordCategories.First().Name;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading word categories: {ex.Message}");
        }
    }

    private void GenerateSuggestedNames()
    {
        var allNames = new List<string>
        {
            "SneakyPanda", "NinjaTaco", "CosmicBurrito", "CaptainChaos", "MysteryMuffin", "ShadowPickle",
            "WizardWaffle", "StealthySpoon", "RogueRabbit", "SecretSauce", "PhantomPizza", "CloakedCookie",
            "SpySquirrel", "HiddenHamster", "DeceptiveDuck", "TrickyTurtle", "SlySalmon", "CraftyCarrot",
            "SneakySnail", "CleverCactus", "WilyWombat", "DeviantDonut", "MischievousMango", "CunningCupcake",
            "ArtfulAvocado", "SubtleSandwich", "ElusiveEggplant", "FoxyFalafel", "GuiltyGrape", "LurkerLemon",
            "BanditBagel", "RascalRadish", "VagabondVegetable", "OutlawOnion", "RebelRice", "PiratePickle",
            "ThiefTaco", "MarauderMuffin", "ScoundrelSoup", "VillainVanilla", "RogueRamen", "TricksterTofu"
        };

        var random = new Random();
        suggestedNames = allNames.OrderBy(x => random.Next()).Take(12).ToList();
    }

    private async Task OnPlayerCountChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int count))
        {
            playerCount = count;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void AddSuggestedPlayer(string name)
    {
        if (CanAddPlayer() && !players.Any(p => p.Name.Equals(name, StringComparison.OrdinalIgnoreCase)))
        {
            players.Add(new GamePlayer { Id = Guid.NewGuid().ToString(), Name = name });
            suggestedNames.Remove(name); // Remove from suggestions once added
            StateHasChanged();
        }
    }

    private async Task OnPlayerNameKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await AddPlayer();
        }
    }

    private async Task AddPlayer()
    {
        if (CanAddPlayerWithName())
        {
            var trimmedName = newPlayerName.Trim();
            if (!players.Any(p => p.Name.Equals(trimmedName, StringComparison.OrdinalIgnoreCase)))
            {
                players.Add(new GamePlayer { Id = Guid.NewGuid().ToString(), Name = trimmedName });
                newPlayerName = "";
                await InvokeAsync(StateHasChanged);
            }
        }
    }

    private void RemovePlayer(GamePlayer player)
    {
        players.Remove(player);
        StateHasChanged();
    }

    private bool CanAddPlayer()
    {
        return players.Count < playerCount;
    }

    private bool CanAddPlayerWithName()
    {
        return players.Count < playerCount && !string.IsNullOrWhiteSpace(newPlayerName);
    }

    private bool CanStartGame()
    {
        return players.Count >= 3 && players.Count == playerCount && !string.IsNullOrEmpty(selectedCategoryName);
    }

    private async Task StartGame()
    {
        try
        {
            var selectedCategory = wordCategories.FirstOrDefault(c => c.Name == selectedCategoryName);
            if (selectedCategory == null) return;

            // Create game through LocalGameService
            var createGameDto = new CreateGameRequestDTO
            {
                HostNickname = players.FirstOrDefault()?.Name ?? "Host",
                GameType = "Undercover"
            };

            gameState = await LocalGameService.CreateGameAsync(createGameDto);

            // Guard: CreateGameAsync may return null in error scenarios
            if (gameState == null)
            {
                Console.WriteLine("Failed to create game (CreateGameAsync returned null).");
                return;
            }

            // Add players to the game
            foreach (var player in players.Skip(1)) // Skip the first player as they're already the host
            {
                await LocalGameService.JoinGameAsync(gameState.GameId, new JoinGameRequestDTO { Nickname = player.Name });
            }

            // Start the game
            await LocalGameService.StartGameAsync(gameState.GameId);

            // Get updated game state
            gameState = await LocalGameService.GetGameStateAsync(gameState.GameId);
            
            // Set up role assignment
            SetupRoleAssignment(selectedCategory);
            gamePhase = GamePhase.RoleAssignment;
            
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error starting game: {ex.Message}");
        }
    }

    private void SetupRoleAssignment(WordPairCategory category)
    {
        var random = new Random();
        var selectedPair = category.Pairs[random.Next(category.Pairs.Count)];
        currentGameWordPair = selectedPair;

        // Create role distribution
        var roles = new List<string>();
        
        // Add civilians
        for (int i = 0; i < GetCivilianCount(); i++)
        {
            roles.Add(GameConstants.PlayerRoles.Civilian);
        }
        
        // Add undercover
        for (int i = 0; i < GetUndercoverCount(); i++)
        {
            roles.Add(GameConstants.PlayerRoles.Undercover);
        }
        
        // Add Mr. White
        for (int i = 0; i < GetMisterWhiteCount(); i++)
        {
            roles.Add(GameConstants.PlayerRoles.MrWhite);
        }

        // Shuffle roles
        roles = roles.OrderBy(x => random.Next()).ToList();

    // Create available cards (capture currentGameWordPair as nullable)
    availableCards = roles.Select(role => (role, (WordPair?)currentGameWordPair)).ToList();
        currentCardIndex = 0;
    }

    private async Task PickCard(int cardIndex)
    {
        if (cardIndex >= 0 && cardIndex < availableCards.Count)
        {
            var selectedCard = availableCards[cardIndex];
            currentPlayerRole = selectedCard.Role;
            
            // Assign role to current player
            players[currentCardIndex].Role = selectedCard.Role;
            
            // Remove the selected card
            availableCards.RemoveAt(cardIndex);
            
            gamePhase = GamePhase.RoleRevealed;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task ContinueToNextPlayer()
    {
        currentCardIndex++;
        
        if (currentCardIndex >= players.Count)
        {
            // All players have picked cards, start discussion
            gamePhase = GamePhase.Discussion;
        }
        else
        {
            // Next player's turn
            gamePhase = GamePhase.RoleAssignment;
            currentPlayerRole = null;
        }
        
        await InvokeAsync(StateHasChanged);
    }

    private List<GamePlayer> GetSpeakingOrder()
    {
        // Get all non-Mr. White players first, then Mr. White players
        var nonMrWhitePlayers = players.Where(p => p.Role != GameConstants.PlayerRoles.MrWhite).ToList();
        var mrWhitePlayers = players.Where(p => p.Role == GameConstants.PlayerRoles.MrWhite).ToList();
        
        // Randomize the order within each group
        var random = new Random();
        nonMrWhitePlayers = nonMrWhitePlayers.OrderBy(x => random.Next()).ToList();
        mrWhitePlayers = mrWhitePlayers.OrderBy(x => random.Next()).ToList();
        
        // Combine: non-Mr. White first, then Mr. White
        return nonMrWhitePlayers.Concat(mrWhitePlayers).ToList();
    }

    private async Task StartVoting()
    {
        discussionTimer?.Dispose();
        gamePhase = GamePhase.Voting;
        selectedVoteTarget = null;
        
        // Start voting timer (5 minutes)
        votingTimeRemaining = 300;
        votingTimer = new Timer(async _ =>
        {
            votingTimeRemaining--;
            await InvokeAsync(StateHasChanged);
            
            if (votingTimeRemaining <= 0)
            {
                votingTimer?.Dispose();
                // Auto-submit vote or show time's up message
                if (selectedVoteTarget != null)
                {
                    await SubmitVote();
                }
            }
        }, null, TimeSpan.FromSeconds(1), TimeSpan.FromSeconds(1));
        
        await InvokeAsync(StateHasChanged);
    }

    private void SelectVoteTarget(string playerId)
    {
        selectedVoteTarget = playerId;
        StateHasChanged();
    }

    private async Task SubmitVote()
    {
        if (selectedVoteTarget != null)
        {
            votingTimer?.Dispose();
            
            var votedPlayer = players.FirstOrDefault(p => p.Id == selectedVoteTarget);
            if (votedPlayer != null)
            {
                // Check if Mr. White was voted out
                if (votedPlayer.Role == GameConstants.PlayerRoles.MrWhite)
                {
                    votedOutMrWhite = votedPlayer;
                    gamePhase = GamePhase.MrWhiteGuess;
                    mrWhiteGuess = "";
                    await InvokeAsync(StateHasChanged);
                }
                else
                {
                    // Normal voting result
                    DetermineGameResult(votedPlayer);
                    gamePhase = GamePhase.Results;
                    await InvokeAsync(StateHasChanged);
                }
            }
        }
    }

    private async Task OnMrWhiteGuessKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SubmitMrWhiteGuess();
        }
    }

    private async Task SubmitMrWhiteGuess()
    {
        if (string.IsNullOrWhiteSpace(mrWhiteGuess) || votedOutMrWhite == null || currentGameWordPair == null)
            return;

        var guess = mrWhiteGuess.Trim();
        var civilianWord = currentGameWordPair.Civilian;

        if (guess.Equals(civilianWord, StringComparison.OrdinalIgnoreCase))
        {
            // Mr. White guessed correctly - wins the round
            gameResult = new GameResultDTO
            {
                Winner = "Mr. White",
                Reason = $"Mr. White ({votedOutMrWhite.Name}) correctly guessed the civilian word: '{civilianWord}'!"
            };
            
            // Award 3 points to Mr. White
            votedOutMrWhite.Score += 3;
            
            gamePhase = GamePhase.Results;
        }
        else
        {
            // Mr. White guessed wrong - show elimination phase
            gamePhase = GamePhase.MrWhiteEliminated;
        }
        
        await InvokeAsync(StateHasChanged);
    }

    private async Task ContinueWithoutMrWhite()
    {
        if (votedOutMrWhite == null) return;

        // Remove Mr. White from the game
        players.Remove(votedOutMrWhite);
        
        // Check if game should end (only 2 players left, etc.)
        if (players.Count <= 2)
        {
            // Determine winner based on remaining players
            var remainingUndercover = players.Where(p => p.Role == GameConstants.PlayerRoles.Undercover).ToList();
            var remainingCivilians = players.Where(p => p.Role == GameConstants.PlayerRoles.Civilian).ToList();
            
            if (remainingUndercover.Any() && remainingCivilians.Any())
            {
                gameResult = new GameResultDTO
                {
                    Winner = "Draw",
                    Reason = "Too few players remaining to continue."
                };
            }
            else if (remainingUndercover.Any())
            {
                gameResult = new GameResultDTO
                {
                    Winner = "Undercover",
                    Reason = "All civilians eliminated!"
                };
                foreach (var player in remainingUndercover)
                {
                    player.Score++;
                }
            }
            else
            {
                gameResult = new GameResultDTO
                {
                    Winner = "Civilians",
                    Reason = "All undercover agents eliminated!"
                };
                foreach (var player in remainingCivilians)
                {
                    player.Score++;
                }
            }
            
            gamePhase = GamePhase.Results;
        }
        else
        {
            // Continue with another word sharing round
            gamePhase = GamePhase.Discussion; // Word Sharing Phase
            selectedVoteTarget = null;
            votedOutMrWhite = null;
            mrWhiteGuess = "";
        }
        
        await InvokeAsync(StateHasChanged);
    }

    private async Task StartNewWordRound()
    {
        await ContinueWithoutMrWhite();
    }

    private void DetermineGameResult(GamePlayer votedOutPlayer)
    {
        gameResult = new GameResultDTO();
        
        if (votedOutPlayer.Role == GameConstants.PlayerRoles.Undercover)
        {
            gameResult.Winner = "Civilians";
            gameResult.Reason = "The Undercover agent was successfully identified!";
            
            // Award points to civilians
            foreach (var player in players.Where(p => p.Role == GameConstants.PlayerRoles.Civilian))
            {
                player.Score++;
            }
        }
        else if (votedOutPlayer.Role == GameConstants.PlayerRoles.Civilian)
        {
            gameResult.Winner = "Undercover";
            gameResult.Reason = "A Civilian was voted out - Undercover wins!";
            
            // Award points to undercover players
            foreach (var player in players.Where(p => p.Role == GameConstants.PlayerRoles.Undercover))
            {
                player.Score++;
            }
        }
        else // Mr. White
        {
            gameResult.Winner = "Mr. White";
            gameResult.Reason = "Mr. White was voted out but wins for surviving this long!";
            
            // Award points to Mr. White
            foreach (var player in players.Where(p => p.Role == GameConstants.PlayerRoles.MrWhite))
            {
                player.Score++;
            }
        }

        if (gameState != null)
        {
            gameState.Status = GameStatus.Finished;
        }
    }

    private async Task ResetGame()
    {
        gamePhase = GamePhase.Setup;
        gameState = null;
        gameResult = null;
        players.Clear();
        newPlayerName = "";
        availableCards.Clear();
        currentCardIndex = 0;
        currentPlayerRole = null;
        currentGameWordPair = null;
        selectedVoteTarget = null;
        discussionTimeRemaining = 0;
        discussionTimer?.Dispose();
        votingTimeRemaining = 0;
        votingTimer?.Dispose();
        votedOutMrWhite = null;
        mrWhiteGuess = "";
        
        GenerateSuggestedNames();
        await InvokeAsync(StateHasChanged);
    }

    private async Task NextRound()
    {
        // Keep the same players and configuration, but start a new round
        gamePhase = GamePhase.RoleAssignment;
        gameState = null;
        gameResult = null;
        availableCards.Clear();
        currentCardIndex = 0;
        currentPlayerRole = null;
        currentGameWordPair = null;
        selectedVoteTarget = null;
        discussionTimeRemaining = 0;
        discussionTimer?.Dispose();
        votingTimeRemaining = 0;
        votingTimer?.Dispose();
        votedOutMrWhite = null;
        mrWhiteGuess = "";
        
        // Reset all players to have no role assignments for the new round
        foreach (var player in players)
        {
            player.Role = "";
        }
        
        // Start the new game with the same configuration
        await StartGame();
    }

    // Helper methods
    private int GetCivilianCount()
    {
        return playerCount switch
        {
            3 => 2,  // 2 civilians, 1 undercover, 0 white
            4 => 2,  // 2 civilians, 1 undercover, 1 white
            5 => 3,  // 3 civilians, 1 undercover, 1 white
            6 => 3,  // 3 civilians, 2 undercover, 1 white
            7 => 4,  // 4 civilians, 2 undercover, 1 white
            8 => 4,  // 4 civilians, 2 undercover, 2 white
            9 => 5,  // 5 civilians, 2 undercover, 2 white
            10 => 5, // 5 civilians, 3 undercover, 2 white
            _ => Math.Max(1, playerCount - GetUndercoverCount() - GetMisterWhiteCount())
        };
    }

    private int GetUndercoverCount()
    {
        return playerCount switch
        {
            3 => 1,
            4 => 1,
            5 => 1,
            6 => 2,
            7 => 2,
            8 => 2,
            9 => 2,
            10 => 3,
            _ => 1
        };
    }

    private int GetMisterWhiteCount()
    {
        return playerCount switch
        {
            3 => 0,
            4 => 1,
            5 => 1,
            6 => 1,
            7 => 1,
            8 => 2,
            9 => 2,
            10 => 2,
            _ => playerCount >= 4 ? 1 : 0
        };
    }

    private string GetRoleDisplayName(string role)
    {
        return role switch
        {
            GameConstants.PlayerRoles.Civilian => "Civilian",
            GameConstants.PlayerRoles.Undercover => "Undercover Agent",
            GameConstants.PlayerRoles.MrWhite => "Mr. White",
            _ => "Unknown"
        };
    }

    private string FormatTime(int seconds)
    {
        var minutes = seconds / 60;
        var remainingSeconds = seconds % 60;
        return $"{minutes:D2}:{remainingSeconds:D2}";
    }

    public void Dispose()
    {
        discussionTimer?.Dispose();
        votingTimer?.Dispose();
    }
}
